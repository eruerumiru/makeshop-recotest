<!doctype html>
<meta charset="utf-8">
<title>アルパカPC かんたんおすすめ</title>

<div id="app" style="max-width:720px;margin:20px auto;font-family:system-ui, sans-serif;">
  <div style="border:1px solid #eee;border-radius:12px;padding:14px;">
    <div style="font-weight:700;font-size:18px;margin-bottom:10px;">かんたんPCえらび（店員モード）</div>
    <div id="chat" style="display:flex;flex-direction:column;gap:10px;"></div>
    <div id="choices" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;"></div>
  </div>
</div>

<script>
const API = "https://makeshop-recotest.vercel.app/api/recommend";

const state = {
  useCase: null,     // office/zoom/creator/game
  budget: null,      // number
  device: "any",     // any/laptop/desktop
  needsCamera: false,
  needsTenkey: false,
};

const chat = document.getElementById("chat");
const choices = document.getElementById("choices");

function say(who, text){
  const div = document.createElement("div");
  div.style.padding = "10px 12px";
  div.style.borderRadius = "10px";
  div.style.maxWidth = "92%";
  div.style.whiteSpace = "pre-wrap";
  div.style.lineHeight = "1.4";
  div.style.background = who==="bot" ? "#f7f7f7" : "#111";
  div.style.color = who==="bot" ? "#111" : "#fff";
  div.style.alignSelf = who==="bot" ? "flex-start" : "flex-end";
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function btn(label, onClick){
  const b = document.createElement("button");
  b.textContent = label;
  b.style.padding = "8px 10px";
  b.style.border = "1px solid #ddd";
  b.style.borderRadius = "10px";
  b.style.background = "#fff";
  b.style.cursor = "pointer";
  b.onclick = onClick;
  return b;
}

function setChoices(list){
  choices.innerHTML = "";
  list.forEach(x => choices.appendChild(btn(x.label, x.onClick)));
}

function reset(){
  chat.innerHTML = "";
  Object.assign(state, {useCase:null, budget:null, device:"any", needsCamera:false, needsTenkey:false});
  flow1();
}

function flow1(){
  say("bot","どこで使う予定？（迷っててもOK）");
  setChoices([
    {label:"家の机で使う（据え置き）", onClick: ()=>{ say("me","家の机で"); state.device="desktop"; flow2(); }},
    {label:"持ち運ぶ（外でも使う）", onClick: ()=>{ say("me","持ち運ぶ"); state.device="laptop"; flow2(); }},
    {label:"どっちも（まだ決めてない）", onClick: ()=>{ say("me","どっちも"); state.device="any"; flow2(); }},
  ]);
}

function flow2(){
  say("bot","なにに使う？いちばん近いのを選んでね");
  setChoices([
    {label:"事務・ネット・YouTube", onClick: ()=>{ say("me","普段使い"); state.useCase="office"; flow3(); }},
    {label:"Zoom・オンライン会議", onClick: ()=>{ say("me","Zoom"); state.useCase="zoom"; state.needsCamera=true; flow3(); }},
    {label:"写真・軽い編集", onClick: ()=>{ say("me","写真編集"); state.useCase="creator"; flow3(); }},
    {label:"動画編集（重め）", onClick: ()=>{ say("me","動画編集"); state.useCase="creator"; flow3(); }},
    {label:"ゲーム", onClick: ()=>{ say("me","ゲーム"); state.useCase="game"; flow3(); }},
  ]);
}

function flow3(){
  say("bot","こだわりある？（なければ「特になし」でOK）");
  setChoices([
    {label:"Webカメラ必須", onClick: ()=>{ say("me","Webカメラ必須"); state.needsCamera=true; flow4(); }},
    {label:"テンキー必須", onClick: ()=>{ say("me","テンキー必須"); state.needsTenkey=true; flow4(); }},
    {label:"特になし", onClick: ()=>{ say("me","特になし"); flow4(); }},
  ]);
}

function flow4(){
  say("bot","予算の上限はいくら？（中古は使い切らなくてOKだよ）");
  setChoices([
    {label:"～2万円", onClick: ()=>{ say("me","2万円まで"); state.budget=20000; recommend(); }},
    {label:"～3万円", onClick: ()=>{ say("me","3万円まで"); state.budget=30000; recommend(); }},
    {label:"～4万円", onClick: ()=>{ say("me","4万円まで"); state.budget=40000; recommend(); }},
    {label:"～6万円", onClick: ()=>{ say("me","6万円まで"); state.budget=60000; recommend(); }},
    {label:"こだわらない", onClick: ()=>{ say("me","こだわらない"); state.budget=80000; recommend(); }},
  ]);
}

async function recommend(){
  setChoices([{label:"最初からやり直す", onClick: reset}]);
  say("bot","在庫から探してるよ…");

  const payload = {
    useCase: state.useCase,
    budget: state.budget,
    device: state.device,
    needsCamera: state.needsCamera,
    needsTenkey: state.needsTenkey,
  };

  try{
    const r = await fetch(API, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const d = await r.json();
    if(!d.ok){
      say("bot","ごめん、エラー出た：" + (d.error||"不明"));
      return;
    }

    // meta.note があれば先に出す
    if(d.meta && d.meta.note) say("bot", d.meta.note);

    if(!d.products || !d.products.length){
      say("bot","条件に合う在庫が見つからなかったよ。条件をゆるめてみて！");
      return;
    }

    // 結果
    d.products.forEach(p=>{
      const price = Number(p.price||0).toLocaleString();
      const s = p.spec || {};
      const line =
`${p.tier}：${p.name}
価格：${price}円
目安：CPU ${s.cpu||"不明"} / メモリ ${s.memGB||"?"}GB / SSD ${s.ssdGB||"?"}GB
${p.url ? "商品ページ："+p.url : ""}

理由：${p.reason || ""}`;
      say("bot", line);
    });

  }catch(e){
    say("bot","通信エラー：" + e);
  }
}

reset();
</script>
